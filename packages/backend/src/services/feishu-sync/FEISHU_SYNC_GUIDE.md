# 飞书多维表格同步任务使用说明

## 功能概述

该任务会将数据库中的用户数据（`UserSpaceData` 和 `UserCard`）同步到飞书多维表格中。

## 配置步骤

### 1. 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/app)
2. 创建企业自建应用
3. 获取 `App ID` 和 `App Secret`

### 2. 配置应用权限

在飞书应用管理后台，需要开通以下权限：

**云文档权限：**

- `drive:drive` - 云空间文件读写权限
- `bitable:app` - 多维表格应用读写权限

**多维表格权限：**

- `bitable:app` - 查看、编辑、管理多维表格
- `bitable:table` - 查看、编辑数据表
- `bitable:record` - 查看、新增、编辑、删除记录

### 3. 配置环境变量

在 `packages/backend/.env` 文件中添加：

```env
FEISHU_APP_ID=cli_your_app_id_here
FEISHU_APP_SECRET=your_app_secret_here
```

### 4. 启用触发器

在 `trigger.config.ts` 中找到飞书同步任务配置，将 `enabled` 设置为 `true`：

```typescript
{
  name: "feishu-bitable-sync-daily",
  taskName: "feishu-bitable-sync",
  cron: "0 0 1 * * *", // 每天凌晨1点
  params: {
    mids: [456664753] // 可以指定用户列表，或留空同步所有用户
  },
  enabled: true, // 改为 true
  description: "同步用户数据到飞书多维表格"
}
```

## 数据结构

### 文件夹结构

```
bili/                          # 根文件夹
├── 用户A/                    # 用户子文件夹（以用户名命名）
│   └── 用户A的数据/          # 多维表格
│       ├── 用户状态          # 数据表1：存储不常变化的数据
│       └── 用户统计          # 数据表2：存储经常变化的数据
├── 用户B/
│   └── 用户B的数据/
│       ├── 用户状态
│       └── 用户统计
```

### 用户状态表字段

| 字段名   | 类型 | 说明          |
| -------- | ---- | ------------- |
| 用户ID   | 数字 | 用户的mid     |
| 用户名   | 文本 | 用户昵称      |
| 性别     | 文本 | 性别          |
| 头像     | URL  | 头像链接      |
| 签名     | 文本 | 个性签名      |
| 等级     | 数字 | 用户等级      |
| 生日     | 文本 | 生日（MM-DD） |
| 认证信息 | 文本 | JSON格式      |
| 会员信息 | 文本 | JSON格式      |
| 头像框   | 文本 | JSON格式      |
| 勋章     | 文本 | JSON格式      |
| 更新时间 | 日期 | 记录更新时间  |

**特点：** 只有当数据发生变化时才会插入新记录，避免冗余。

### 用户统计表字段

| 字段名   | 类型   | 说明         |
| -------- | ------ | ------------ |
| 用户ID   | 数字   | 用户的mid    |
| 粉丝数   | 数字   | 粉丝数量     |
| 关注数   | 数字   | 关注数量     |
| 稿件数   | 数字   | 投稿数量     |
| 专栏数   | 数字   | 专栏数量     |
| 点赞数   | 数字   | 获赞数量     |
| 被关注   | 复选框 | 是否被关注   |
| 已关注   | 复选框 | 是否已关注   |
| 记录时间 | 日期   | 数据记录时间 |

**特点：** 每次同步都会插入新记录，用于观察数据变化趋势。

## 手动触发

可以通过API手动触发任务：

```bash
POST http://localhost:9000/task/execute

{
  "taskName": "feishu-bitable-sync",
  "params": {
    "mids": [456664753]  # 可选：指定要同步的用户ID列表
  }
}
```

## 常见问题

### 1. 权限不足

**错误信息：** `Permission denied`

**解决方案：**

- 确认飞书应用已开通所需权限
- 重新发布应用版本
- 等待权限生效（可能需要几分钟）

### 2. 找不到文件夹

**错误信息：** `Folder not found`

**解决方案：**

- 任务会自动创建 `bili` 文件夹和用户子文件夹
- 确认应用有云文档的写权限

### 3. 同名文件夹冲突

任务会自动检测文件夹是否存在，避免创建重复文件夹。如果手动创建了同名文件夹，任务会使用现有文件夹。

### 4. 数据未同步

**检查项：**

- 数据库中是否有对应的用户数据
- 查看任务执行日志
- 确认触发器已启用
- 检查环境变量配置是否正确

## 注意事项

1. **初次运行：** 首次运行会创建完整的文件夹结构和数据表
2. **增量同步：** 用户状态表会对比最新记录，只在有变化时插入
3. **定时执行：** 默认每天凌晨1点执行，可根据需要调整cron表达式
4. **数据安全：** 飞书应用的 App Secret 请妥善保管，不要泄露
5. **API限流：** 飞书API有频率限制，大量用户同步时请注意控制并发

## 开发调试

查看任务执行日志：

```bash
# 启动后端服务
cd packages/backend
pnpm dev

# 查看控制台输出
# 日志会显示每一步的执行情况
```

## 技术支持

如遇到问题，请提供：

- 错误日志
- 飞书应用权限截图
- 环境变量配置（隐藏敏感信息）
